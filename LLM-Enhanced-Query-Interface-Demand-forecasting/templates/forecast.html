<!DOCTYPE html>
<html>
  <head>
    <title>Demand Forecasting - M5 Database</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #333;
        border-bottom: 4px solid #667eea;
        padding-bottom: 15px;
        margin-bottom: 20px;
        font-size: 2.5em;
      }
      .badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 20px;
        border-radius: 25px;
        font-size: 14px;
        margin-left: 15px;
        font-weight: bold;
      }
      .nav-links {
        margin: 20px 0;
      }
      .nav-link {
        display: inline-block;
        margin-right: 10px;
        padding: 10px 20px;
        background: #f5f5f5;
        color: #333;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s;
      }
      .nav-link:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      /* Input Section */
      .input-section {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 25px;
        border-radius: 10px;
        margin: 25px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .input-section h2 {
        color: #555;
        margin-bottom: 20px;
        font-size: 1.8em;
      }
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .input-group {
        margin: 15px 0;
      }
      .input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #555;
        font-size: 14px;
      }
      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        transition: border 0.3s;
      }
      .input-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .required {
        color: #e74c3c;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 14px 35px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-top: 15px;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }
      button:active {
        transform: translateY(0);
      }

      /* Summary Box */
      .summary-box {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        padding: 30px;
        border-radius: 12px;
        margin: 25px 0;
        border-left: 6px solid #4caf50;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
      }
      .summary-box h2 {
        margin-top: 0;
        color: #2e7d32;
        display: flex;
        align-items: center;
        font-size: 1.8em;
      }
      .summary-box h2 .icon {
        margin-right: 10px;
        font-size: 1.2em;
      }
      .summary-content {
        white-space: pre-wrap;
        line-height: 1.8;
        color: #1b5e20;
        font-size: 16px;
        margin-top: 15px;
      }

      /* Metrics Grid */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 25px 0;
      }
      .metric-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s;
        border-top: 4px solid #667eea;
      }
      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
      }
      .metric-label {
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Alerts */
      .alert {
        padding: 18px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 5px solid;
        display: flex;
        align-items: flex-start;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .alert-icon {
        font-size: 24px;
        margin-right: 15px;
      }
      .alert-high {
        background: #ffebee;
        border-color: #f44336;
        color: #c62828;
      }
      .alert-medium {
        background: #fff3e0;
        border-color: #ff9800;
        color: #e65100;
      }
      .alert-low {
        background: #e3f2fd;
        border-color: #2196f3;
        color: #1565c0;
      }
      .alert-critical {
        background: #f3e5f5;
        border-color: #9c27b0;
        color: #6a1b9a;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      /* Recommendations */
      .recommendation {
        background: #f5f5f5;
        padding: 20px;
        margin: 15px 0;
        border-radius: 10px;
        border-left: 5px solid #667eea;
        transition: all 0.3s;
      }
      .recommendation:hover {
        background: #e8eaf6;
        transform: translateX(5px);
      }
      .recommendation.high {
        border-color: #f44336;
      }
      .recommendation.medium {
        border-color: #ff9800;
      }
      .recommendation.low {
        border-color: #4caf50;
      }
      .recommendation strong {
        color: #333;
        font-size: 16px;
      }
      .recommendation .details {
        color: #666;
        font-size: 14px;
        margin-top: 8px;
        line-height: 1.6;
      }

      /* Charts */
      .chart-container {
        margin: 25px 0;
        padding: 25px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .chart-container h2 {
        color: #555;
        margin-bottom: 20px;
        font-size: 1.6em;
      }
      .chart-wrapper {
        position: relative;
        height: 400px;
      }
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
      }

      /* Error */
      .error {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        padding: 20px;
        border-left: 5px solid #f44336;
        margin: 20px 0;
        color: #c62828;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
      }
      .error strong {
        display: block;
        margin-bottom: 10px;
        font-size: 18px;
      }

      /* Section */
      .section {
        margin: 35px 0;
      }
      .section h2 {
        color: #555;
        border-bottom: 3px solid #e0e0e0;
        padding-bottom: 12px;
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      /* Details Box */
      .details-box {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .details-box p {
        margin: 8px 0;
        color: #555;
      }
      .details-box strong {
        color: #333;
      }

      /* Loading Spinner */
      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }
        h1 {
          font-size: 1.8em;
        }
        .form-grid {
          grid-template-columns: 1fr;
        }
        .charts-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Demand Forecasting for M5 Database</h1>

      <div class="nav-links">
        <a href="/" class="nav-link">‚Üê Query Interface</a>
      </div>

      <!-- Input Form -->
      <div class="input-section">
        <h2>üîÆ Generate Forecast</h2>
        <form method="POST" action="/forecast/" id="forecastForm">
          <div class="form-grid">
            <div class="input-group">
              <label for="item_id"
                >Item ID <span class="required">*</span></label
              >
              <input
                type="text"
                id="item_id"
                name="item_id"
                placeholder="e.g., FOODS_3_090"
                value="{{ item_id }}"
                required
              />
            </div>

            <div class="input-group">
              <label for="store_id"
                >Store ID <span class="required">*</span></label
              >
              <input
                type="text"
                id="store_id"
                name="store_id"
                placeholder="e.g., CA_1"
                value="{{ store_id }}"
                required
              />
            </div>

            <div class="input-group">
              <label for="horizon">Forecast Horizon (days)</label>
              <input
                type="number"
                id="horizon"
                name="horizon"
                value="{{ horizon if horizon else 28 }}"
                min="7"
                max="90"
              />
            </div>

            <div class="input-group">
              <label for="current_inventory"
                >Current Inventory (optional)</label
              >
              <input
                type="number"
                id="current_inventory"
                name="current_inventory"
                placeholder="e.g., 150"
                value="{{ current_inventory }}"
                step="0.01"
              />
            </div>
          </div>

          <button type="submit" onclick="showLoading()">
            üöÄ Generate Forecast
          </button>
        </form>

        <div class="loading" id="loadingSpinner">
          <div class="spinner"></div>
          <p style="margin-top: 15px; color: #666">Generating forecast...</p>
        </div>
      </div>

      <!-- Error Message -->
      {% if error %}
      <div class="error">
        <strong>‚ùå Error</strong>
        {{ error }}
      </div>
      {% endif %}

      <!-- NLG Summary -->
      {% if summary %}
      <div class="summary-box">
        <h2><span class="icon">üí¨</span>Executive Summary</h2>
        <div class="summary-content">{{ summary }}</div>
      </div>
      {% endif %}

      <!-- Inventory Metrics -->
      {% if inventory_metrics %}
      <div class="section">
        <h2>üìä Inventory Metrics</h2>
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.1f"|format(inventory_metrics.avg_daily_demand) }}
            </div>
            <div class="metric-label">Avg Daily Demand</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.0f"|format(inventory_metrics.total_forecast) }}
            </div>
            <div class="metric-label">Total Forecast</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.0f"|format(inventory_metrics.reorder_point) }}
            </div>
            <div class="metric-label">Reorder Point</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.0f"|format(inventory_metrics.safety_stock) }}
            </div>
            <div class="metric-label">Safety Stock</div>
          </div>
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.0f"|format(inventory_metrics.eoq) }}
            </div>
            <div class="metric-label">Economic Order Qty</div>
          </div>
          {% if inventory_metrics.days_of_stock %}
          <div class="metric-card">
            <div class="metric-value">
              {{ "%.0f"|format(inventory_metrics.days_of_stock) }}
            </div>
            <div class="metric-label">Days of Stock</div>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Alerts -->
      {% if alerts %}
      <div class="section">
        <h2>‚ö†Ô∏è Alerts</h2>
        {% for alert in alerts %}
        <div class="alert alert-{{ alert.urgency|lower }}">
          <div class="alert-icon">
            {% if alert.urgency == 'CRITICAL' %}üö® {% elif alert.urgency ==
            'HIGH' %}‚ö†Ô∏è {% elif alert.urgency == 'MEDIUM' %}‚ö° {% else %}‚ÑπÔ∏è{%
            endif %}
          </div>
          <div><strong>[{{ alert.urgency }}]</strong> {{ alert.message }}</div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Recommendations -->
      {% if recommendations %}
      <div class="section">
        <h2>üí° Recommendations</h2>
        {% for rec in recommendations %}
        <div class="recommendation {{ rec.priority|lower }}">
          <strong>[{{ rec.priority }}] {{ rec.action }}</strong>
          <div>{{ rec.message }}</div>
          <div class="details">{{ rec.details }}</div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Charts -->
      {% if chart_data %}
      <div class="chart-container">
        <h2>üìà Demand Forecast Visualization</h2>
        <div class="chart-wrapper">
          <canvas id="forecastChart"></canvas>
        </div>
      </div>
      {% endif %} {% if metrics_chart or comparison_chart %}
      <div class="charts-grid">
        {% if metrics_chart %}
        <div class="chart-container">
          <h2>üìä Inventory Metrics</h2>
          <div class="chart-wrapper" style="height: 300px">
            <canvas id="metricsChart"></canvas>
          </div>
        </div>
        {% endif %} {% if comparison_chart %}
        <div class="chart-container">
          <h2>üìâ Demand Comparison</h2>
          <div class="chart-wrapper" style="height: 300px">
            <canvas id="comparisonChart"></canvas>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Forecast Details -->
      {% if forecast_result %}
      <div class="section">
        <h2>üìã Forecast Summary</h2>
        <div class="details-box">
          <p><strong>Item ID:</strong> {{ forecast_result.item_id }}</p>
          <p><strong>Store ID:</strong> {{ forecast_result.store_id }}</p>
          <p>
            <strong>Forecast Horizon:</strong> {{ forecast_result.horizon }}
            days
          </p>
          <p><strong>Model Used:</strong> {{ forecast_result.model_used }}</p>
          <p>
            <strong>Historical Mean:</strong> {{
            "%.2f"|format(forecast_result.summary.historical_mean) }} units/day
          </p>
          <p>
            <strong>Forecast Mean:</strong> {{
            "%.2f"|format(forecast_result.summary.forecast_mean) }} units/day
          </p>
          <p>
            <strong>Service Level:</strong> {{ (inventory_metrics.service_level
            * 100)|int }}%
          </p>
          <p>
            <strong>Lead Time:</strong> {{ inventory_metrics.lead_time_days }}
            days
          </p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Chart.js Scripts -->
    {% if chart_data %}
    <script>
      // Main Forecast Chart
      const ctx = document.getElementById("forecastChart").getContext("2d");
      const chartData = JSON.parse("{{ chart_data | tojson | safe }}");

      new Chart(ctx, {
        type: chartData.type,
        data: {
          labels: chartData.labels,
          datasets: chartData.datasets,
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: "Demand Forecast with 95% Confidence Intervals",
              font: { size: 16, weight: "bold" },
            },
            legend: {
              display: true,
              position: "top",
            },
            tooltip: {
              mode: "index",
              intersect: false,
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Units",
                font: { size: 14, weight: "bold" },
              },
            },
            x: {
              title: {
                display: true,
                text: "Date",
                font: { size: 14, weight: "bold" },
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45,
              },
            },
          },
        },
      });
    </script>
    {% endif %} {% if metrics_chart %}
    <script>
      // Metrics Chart
      const ctxMetrics = document
        .getElementById("metricsChart")
        .getContext("2d");
      const metricsData = JSON.parse("{{ metrics_chart | tojson | safe }}");

      new Chart(ctxMetrics, {
        type: metricsData.type,
        data: {
          labels: metricsData.labels,
          datasets: metricsData.datasets,
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Units",
              },
            },
          },
        },
      });
    </script>
    {% endif %} {% if comparison_chart %}
    <script>
      // Comparison Chart
      const ctxComparison = document
        .getElementById("comparisonChart")
        .getContext("2d");
      const comparisonData = JSON.parse(
        "{{ comparison_chart | tojson | safe }}"
      );

      new Chart(ctxComparison, {
        type: comparisonData.type,
        data: {
          labels: comparisonData.labels,
          datasets: comparisonData.datasets,
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Units/Day",
              },
            },
          },
        },
      });
    </script>
    {% endif %}

    <script>
      function showLoading() {
        document.getElementById("loadingSpinner").style.display = "block";
      }
    </script>
  </body>
</html>
